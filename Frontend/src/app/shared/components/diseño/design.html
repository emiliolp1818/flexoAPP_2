<!-- ===== CONTENEDOR PRINCIPAL DE DISEÑOS ===== -->
<!-- Sistema completo de gestión de diseños flexográficos con layout optimizado -->
<div class="design-container">

  <!-- ===== HEADER FIJO ===== -->
  <!-- Header principal que permanece fijo en la parte superior -->
  <div class="design-header">
    <div class="header-content">
      <!-- Información del header -->
      <div class="header-info">
        <h1 class="page-title">
          <mat-icon>design_services</mat-icon>
          Gestión de Diseños Flexográficos
        </h1>
        <p class="page-subtitle">
          Base de datos completa de diseños flexográficos con especificaciones técnicas detalladas
        </p>
      </div>

      <!-- Acciones del header - Botones alineados a la derecha con permisos -->
      <div class="header-actions">
        <!-- Debug: Información del usuario actual -->
        <div class="user-debug-info" *ngIf="currentUser()">
          <small>Usuario: {{ currentUser()?.userCode }} | Rol: {{ currentUser()?.role }}</small>
        </div>

        <!-- Botón Nuevo Diseño - Visible para admin, manager, designer -->
        <button mat-raised-button (click)="createNewDesign()" class="create-design-btn"
          *ngIf="hasPermission('create_design')" matTooltip="Crear un nuevo diseño flexográfico">
          <mat-icon>add</mat-icon>
          Nuevo Diseño
        </button>

        <!-- Botón Carga Masiva Excel - Visible para admin, manager -->
        <button mat-raised-button color="accent" (click)="triggerFileUpload()" class="bulk-upload-btn"
          *ngIf="hasPermission('bulk_upload')" [disabled]="uploading()"
          matTooltip="Subir diseños masivos desde Excel (hasta 200MB)&#10;Formatos: .xlsx, .xls&#10;Columnas requeridas: ArticleF, Client, Description, Substrate, Type, PrintType, ColorCount, Color1-Color10, Status">
          <mat-icon>cloud_upload</mat-icon>
          <span *ngIf="!uploading()">Carga Masiva Excel</span>
          <span *ngIf="uploading()">Subiendo... {{uploadProgress()}}%</span>
        </button>

        <!-- Botón Limpiar Base de Datos - Solo para administradores -->
        <button mat-stroked-button color="warn" (click)="clearAllDesigns()" class="clear-db-btn"
          *ngIf="hasPermission('admin_clear_db')"
          matTooltip="⚠️ PELIGRO: Elimina TODOS los diseños de la base de datos&#10;Solo para administradores">
          <mat-icon>delete_sweep</mat-icon>
          Limpiar BD
        </button>

        <!-- Botón de Debug Temporal - Mostrar siempre para testing -->
        <button mat-stroked-button (click)="debugPermissions()" class="debug-btn"
          matTooltip="Debug: Ver permisos del usuario actual">
          <mat-icon>bug_report</mat-icon>
          Debug
        </button>

        <!-- Botón de Debug de Conexión -->
        <button mat-stroked-button (click)="debugConnection()" class="debug-connection-btn"
          matTooltip="Debug: Probar todas las conexiones de red">
          <mat-icon>network_check</mat-icon>
          Red
        </button>

        <!-- Botones para simular roles (solo para testing) -->
        <div class="role-simulation-buttons" *ngIf="showDebugControls()">
          <button mat-button (click)="simulateUserRole('admin')" class="role-btn admin-btn">Admin</button>
          <button mat-button (click)="simulateUserRole('manager')" class="role-btn manager-btn">Manager</button>
          <button mat-button (click)="simulateUserRole('designer')" class="role-btn designer-btn">Designer</button>
          <button mat-button (click)="simulateUserRole('viewer')" class="role-btn viewer-btn">Viewer</button>
          <button mat-button (click)="resetToDefaultUser()" class="role-btn reset-btn">Reset</button>
        </div>

        <!-- Botón para mostrar/ocultar controles de debug -->
        <button mat-icon-button (click)="toggleDebugControls()" class="toggle-debug-btn"
          matTooltip="Mostrar/Ocultar controles de debug">
          <mat-icon>{{ showDebugControls() ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>

        <!-- Input file oculto para carga masiva -->
        <input #fileInput type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)" style="display: none;"
          multiple="false">
      </div>
    </div>

  </div>



  <!-- ===== ÁREA DE BÚSQUEDA ===== -->
  <!-- Sección de búsqueda y filtros con diseño optimizado -->
  <div class="search-area">
    <mat-card class="search-card">
      <mat-card-content>
        <!-- Sección de búsqueda principal -->
        <div class="search-section">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Buscar diseños</mat-label>
            <input matInput [(ngModel)]="searchTerm" (input)="onSearch()"
              placeholder="Buscar por Artículo F, Cliente o Descripción (ej: F204567, ABSORBENTES, PROTECTORES)">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Botón moderno para limpiar búsqueda -->
          <button mat-icon-button (click)="clearSearch()" *ngIf="searchTerm()" class="clear-search-btn"
            matTooltip="Limpiar búsqueda y mostrar todos los diseños">
            <mat-icon>clear</mat-icon>
          </button>
        </div>

        <!-- Resultados de búsqueda -->
        <div class="search-results" *ngIf="searchTerm()">
          <span class="results-count">
            {{ filteredDesigns().length }} resultado(s) encontrado(s) para "{{ searchTerm() }}"
          </span>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- ===== ÁREA DE TABLA SCROLLABLE ===== -->
  <!-- Contenedor principal de la tabla que ocupa el resto del espacio disponible -->
  <div class="scrollable-table-area">

    <!-- ===== TARJETA DE TABLA ESTILO EXCEL ===== -->
    <!-- Tabla principal con diseño profesional estilo Excel -->
    <mat-card class="table-card">

      <!-- Header de la tabla -->
      <mat-card-header>
        <mat-card-title>
          <mat-icon>table_view</mat-icon>
          Base de Datos de Diseños Flexográficos
          <span *ngIf="!loading()" style="font-size: 0.8rem; color: #64748b; margin-left: 12px;">
            ({{ filteredDesigns().length }} registros)
          </span>
        </mat-card-title>
      </mat-card-header>

      <!-- Contenido de la tabla -->
      <mat-card-content>
        <div class="table-container">

          <!-- ===== TABLA PRINCIPAL ESTILO EXCEL ===== -->
          <!-- Tabla con scroll horizontal y vertical, headers fijos -->
          <table mat-table [dataSource]="filteredDesigns()" class="excel-table">

            <!-- ===== COLUMNA ARTÍCULO F ===== -->
            <!-- Código único del diseño flexográfico (ej: F204567) -->
            <ng-container matColumnDef="articleF">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <mat-icon>tag</mat-icon>
                  <span>Artículo F</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell article-cell">
                <!-- Código del artículo con estilo monospace para mejor legibilidad -->
                <span class="article-code">{{ design.articleF }}</span>
              </td>
            </ng-container>

            <!-- ===== COLUMNA CLIENTE ===== -->
            <!-- Nombre de la empresa cliente (ej: ABSORBENTES DE COLOMBIA S.A) -->
            <ng-container matColumnDef="client">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <mat-icon>business</mat-icon>
                  <span>Cliente</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell client-cell">
                <!-- Nombre del cliente con formato empresarial -->
                <span class="client-name">{{ design.client }}</span>
              </td>
            </ng-container>

            <!-- ===== COLUMNA DESCRIPCIÓN ===== -->
            <!-- Descripción detallada del producto a imprimir -->
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <mat-icon>description</mat-icon>
                  <span>Descripción</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell description-cell">
                <!-- Descripción con tooltip para texto completo y truncado para vista compacta -->
                <span class="description-text" [matTooltip]="design.description">
                  {{ design.description }}
                </span>
              </td>
            </ng-container>

            <!-- ===== COLUMNA SUSTRATO ===== -->
            <!-- Material base sobre el que se imprime (ej: R PE COEX BCO, BOPP PERLADO) -->
            <ng-container matColumnDef="substrate">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <mat-icon>layers</mat-icon>
                  <span>Sustrato</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell substrate-cell">
                <!-- Material del sustrato con estilo distintivo verde -->
                <span class="substrate-text">{{ design.substrate }}</span>
              </td>
            </ng-container>

            <!-- ===== COLUMNA TIPO DE PRODUCTO ===== -->
            <!-- Tipo de estructura del empaque (LAMINA, TUBULAR, SEMITUBULAR) -->
            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <mat-icon>category</mat-icon>
                  <span>Tipo</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell type-cell">
                <!-- Chip con color distintivo según el tipo de producto -->
                <mat-chip [class]="'type-chip type-' + design.type.toLowerCase()">
                  {{ design.type }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- ===== COLUMNA TIPO DE IMPRESIÓN ===== -->
            <!-- Especifica en qué cara(s) se imprime (CARA, DORSO, CARA_DORSO) -->
            <ng-container matColumnDef="printType">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <mat-icon>print</mat-icon>
                  <span>Tipo Impresión</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell print-type-cell">
                <!-- Chip con color según el tipo de impresión (una cara, dorso, ambas caras) -->
                <mat-chip [class]="'print-chip print-' + design.printType.toLowerCase().replace('_', '-')">
                  {{ design.printType.replace('_', ' ') }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- ===== COLUMNA NÚMERO DE COLORES ===== -->
            <!-- Cantidad total de colores utilizados en la impresión -->
            <ng-container matColumnDef="colorCount">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <mat-icon>palette</mat-icon>
                  <span>N° Colores</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell color-count-cell">
                <!-- Badge circular con el número de colores -->
                <div class="color-count-badge">
                  {{ design.colorCount }}
                </div>
              </td>
            </ng-container>

            <!-- ===== COLUMNA COLORES PANTONE - FORMATO TEXTO PALETA ===== -->
            <!-- Paleta de colores PANTONE mostrada como texto con despliegue lateral -->
            <ng-container matColumnDef="colors">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <mat-icon>palette</mat-icon>
                  <span>Paleta</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell colors-cell">
                <div class="colors-cell-container" [attr.data-design-id]="design.id">
                  <button mat-icon-button
                    [class]="'colors-toggle-btn-modern' + (isColorsExpanded(design.id?.toString() || '') ? ' active' : '')"
                    (click)="toggleColors(design.id?.toString() || '', $event)"
                    [attr.title]="'Ver ' + design.colorCount + ' colores'">
                    <div class="colors-icon-container">
                      <mat-icon class="colors-icon">color_lens</mat-icon>
                      <div class="colors-badge">{{ design.colorCount }}</div>
                    </div>
                  </button>
                  
                  <!-- Dropdown de colores con posición fija -->
                  <div class="colors-dropdown" 
                       [class.visible]="isColorsExpanded(design.id?.toString() || '')">
                    <div class="colors-dropdown-content">
                      <div class="colors-dropdown-header">
                        <mat-icon>palette</mat-icon>
                        <span>Colores para {{ design.articleF }}</span>
                        <button mat-icon-button (click)="closeColors(design.id?.toString() || '')"
                          class="close-colors-btn">
                          <mat-icon>close</mat-icon>
                        </button>
                      </div>
                      <div class="colors-dropdown-list">
                        <div *ngFor="let color of design.colors; let i = index" class="color-item">
                          <span class="color-number">{{ i + 1 }}</span>
                          <span class="color-name">{{ formatColorName(color) }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- ===== COLUMNA ESTADO ===== -->
            <!-- Estado actual del diseño (ACTIVO/INACTIVO) para control de producción -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <span>Estado</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell status-cell">
                <!-- Indicador de estado solo con texto y colores -->
                <div [class]="getStatusClass(design)">
                  <span class="status-text">{{ getDesignStatus(design) }}</span>
                </div>
              </td>
            </ng-container>

            <!-- ===== COLUMNA ACCIONES ===== -->
            <!-- Botones de acción para gestionar cada diseño (editar, duplicar, eliminar) -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="excel-header">
                <div class="header-content">
                  <mat-icon>settings</mat-icon>
                  <span>Acciones</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let design" class="excel-cell actions-cell">
                <!-- Grupo de botones de acción con tooltips explicativos -->
                <div class="action-buttons">
                  <!-- Botón Editar: Abre el diálogo de edición -->
                  <button mat-icon-button color="primary" (click)="editDesign(design)"
                    matTooltip="Editar diseño flexográfico">
                    <mat-icon>edit</mat-icon>
                  </button>

                  <!-- Botón Duplicar: Crea una copia del diseño -->
                  <button mat-icon-button color="accent" (click)="duplicateDesign(design)"
                    matTooltip="Duplicar diseño para nuevo proyecto">
                    <mat-icon>content_copy</mat-icon>
                  </button>

                  <!-- Botón Eliminar: Elimina el diseño con confirmación -->
                  <button mat-icon-button color="warn" (click)="deleteDesign(design)"
                    matTooltip="Eliminar diseño permanentemente">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <!-- ===== FILAS DE LA TABLA ===== -->
            <!-- Header fijo que permanece visible durante el scroll -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <!-- Filas de datos con efectos hover y selección -->
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="excel-row"></tr>
          </table>

          <!-- ===== MENSAJE SIN DATOS ===== -->
          <!-- Mostrado cuando no hay diseños o no se encuentran resultados -->
          <div *ngIf="filteredDesigns().length === 0 && !loading()" class="no-data">
            <mat-icon>design_services</mat-icon>
            <!-- Mensaje cuando no hay diseños en la base de datos -->
            <p *ngIf="!searchTerm()">No hay diseños registrados en la base de datos</p>
            <!-- Mensaje cuando la búsqueda no arroja resultados -->
            <p *ngIf="searchTerm()">No se encontraron diseños que coincidan con "{{ searchTerm() }}"</p>
            <!-- Botón para crear el primer diseño -->
            <button mat-raised-button (click)="createNewDesign()" *ngIf="!searchTerm()">
              <mat-icon>add</mat-icon>
              Crear Primer Diseño
            </button>
          </div>

          <!-- ===== MENSAJE DE CARGA ===== -->
          <!-- Mostrado mientras se cargan los datos desde la base de datos -->
          <div *ngIf="loading()" class="loading-container">
            <mat-icon class="loading-icon">refresh</mat-icon>
            <p>Cargando diseños desde la base de datos...</p>
          </div>

        </div>
      </mat-card-content>
    </mat-card>
  </div>

</div>

<!-- ===== COMENTARIOS TÉCNICOS ===== -->
<!--
ESTRUCTURA DEL COMPONENTE DE DISEÑOS:

1. CONTENEDOR PRINCIPAL (.design-container):
   - Ocupa toda la ventana (100vw x 100vh)
   - Sin espacios laterales
   - Layout flexbox vertical

2. HEADER FIJO (.design-header):
   - Permanece visible durante el scroll
   - Contiene título y botón de nuevo diseño
   - Fondo con blur effect

3. ÁREA DE BÚSQUEDA (.search-area):
   - Campo de búsqueda con filtrado en tiempo real
   - Contador de resultados
   - Botón para limpiar búsqueda

4. TABLA EXCEL (.scrollable-table-area):
   - Ocupa el resto del espacio disponible
   - Scroll horizontal y vertical independiente
   - Headers fijos durante el scroll
   - Estilos profesionales tipo Excel

5. COLUMNAS DE LA TABLA:
   - articleF: Código único del diseño
   - client: Empresa cliente
   - description: Descripción del producto
   - substrate: Material base
   - type: Tipo de estructura (LAMINA/TUBULAR/SEMITUBULAR)
   - printType: Cara de impresión (CARA/DORSO/CARA_DORSO)
   - colorCount: Número de colores
   - colors: Paleta PANTONE con vista expandible
   - status: Estado ACTIVO/INACTIVO
   - actions: Botones de gestión

6. CARACTERÍSTICAS TÉCNICAS:
   - Responsive design para móviles y tablets
   - Conexión con base de datos MySQL
   - Fallback a datos mock si no hay conexión
   - Animaciones suaves y efectos hover
   - Tooltips informativos
   - Gestión de estados de carga y error

7. INTEGRACIÓN CON BACKEND:
   - API REST para CRUD de diseños
   - Manejo de errores de conexión
   - Sincronización en tiempo real
   - Validación de datos

8. ACCESIBILIDAD:
   - Contraste de colores adecuado
   - Navegación por teclado
   - Tooltips descriptivos
   - Iconos semánticos
-->